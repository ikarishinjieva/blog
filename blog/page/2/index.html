
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Tac say</title>
  <meta name="author" content="Tac Huang (ikari_shinji@github)">

  
  <meta name="description" content="尝试了&lt;Mysql High Availability&gt;第四章热备份一节的实验,记录步骤. 先统一原语,master/slave/standby表示三台机器名,source/target代表replication关系的两端（不适用master/slave用以和机器名区分）.&#8221 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ikarishinjieva.github.com/blog/blog/page/2/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="Tac say" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>


<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Tac say</a></h1>
  
    <h2>只想做个程序演奏家</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/blog/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article class="b1">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/05/15/mysql-master-slave-standby-failover/" style='font-size:20px'>实验：Mysql Master-slave-standby将source从master切换到standby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-15T22:40:00+08:00" pubdate data-updated="true">May 15<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/05/15/mysql-master-slave-standby-failover/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"实验：Mysql master-slave-standby将source从master切换到standby", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>尝试了&lt;Mysql High Availability&gt;第四章热备份一节的实验,记录步骤.</p>

<p>先统一原语,master/slave/standby表示三台机器名,source/target代表replication关系的两端（不适用master/slave用以和机器名区分）.&#8221;master(3)&#8221;表示master机器的db里有三条数据1,2,3.</p>

<p>实验开始.</p>

<ol>
<li>初始状态是存在master->slave, master->standby的replication</li>
<li>standby在切换成source时,需要有bin-log和replication user. 在此重新设置master->standby的replication, 让standby满足要求.</li>
</ol>


<p>忽略replication user的部分.</p>

<p>bin-log的部分在my.cnf里要设置log-bin和log-slave-updates(默认情况下,master->standby的replication不会写standby的bin-log,需开始standby的log-slave-updates才会写).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server-id               = 3
</span><span class='line'>log_bin                 = /var/log/mysql/mysql-bin.log
</span><span class='line'>...
</span><span class='line'>relay-log-index         = /var/log/mysql/slave-relay-bin.index
</span><span class='line'>relay-log               = /var/log/mysql/slave-relay-bin
</span><span class='line'>log-slave-updates</span></code></pre></td></tr></table></div></figure>


<ol>
<li>测试一下standby binlog设置成功。可以在master插入一条数据，在standby查看</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>standby> show binlog events;
</span><span class='line'>+------------------+------+-------------+-----------+-------------+------------------------------------------------------------------------+
</span><span class='line'>| Log_name         | Pos  | Event_type  | Server_id | End_log_pos | Info                                                                   |
</span><span class='line'>+------------------+------+-------------+-----------+-------------+------------------------------------------------------------------------+
</span><span class='line'>| mysql-bin.000001 |    4 | Format_desc |         3 |         107 | Server ver: 5.5.31-0ubuntu0.12.04.1-log, Binlog ver: 4                 |
</span><span class='line'>| mysql-bin.000001 |  107 | Query       |         1 |         166 | BEGIN                                                                  |
</span><span class='line'>| mysql-bin.000001 |  166 | Query       |         1 |         257 | use `tac`; insert into test values(8889)                               |
</span><span class='line'>| mysql-bin.000001 |  257 | Xid         |         1 |         284 | COMMIT /* xid=111 */    
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<ol>
<li>将replication调整至状态master(3),standby(2),slave(1). 人工造成各db的状态不一致</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master> insert into test values(1);
</span><span class='line'>slave> stop slave;
</span><span class='line'>master> insert into test values(2);
</span><span class='line'>standby> stop slave;
</span><span class='line'>master> insert into test values(3);</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>想象此时master挂掉,开始将source从master切换成standby</p></li>
<li><p>在建立standby->slave的replication之前，需要将standby和slave数据同步(此时slave落后于standby)。</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-- 先查看standby从master拿了多少数据
</span><span class='line'>standby> show slave status \G
</span><span class='line'>*************************** 1. row ***************************
</span><span class='line'>...
</span><span class='line'>        Master_Log_File: master-bin.000023
</span><span class='line'>...
</span><span class='line'>        Exec_Master_Log_Pos: 1391
</span><span class='line'>        
</span><span class='line'>-- 让slave从master上同步到跟standby同样的位置
</span><span class='line'>slave> start slave until master_log_file = 'master-bin.000023', master_log_pos = 1391;</span></code></pre></td></tr></table></div></figure>


<p>有意思的是此处用了master(其实我们假设master已经坏了&#8230;)。</p>

<ol>
<li>此时可以讲slave的source从master切换到standby. 一个问题就是standby->slave的开始位置可能是和master->slave不同</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-- 查看standby binlog的当前位置
</span><span class='line'>mysql> show master status \G
</span><span class='line'>*************************** 1. row ***************************
</span><span class='line'>    File: mysql-bin.000001 
</span><span class='line'>    Position: 796
</span><span class='line'>    Binlog_Do_DB:
</span><span class='line'>  Binlog_Ignore_DB:
</span><span class='line'>-- 注意与master上的文件名和位置都不同
</span><span class='line'>
</span><span class='line'>-- 切换slave的source
</span><span class='line'>slave> change master to 
</span><span class='line'>            master_host = '192.168.50.4', 
</span><span class='line'>            master_port = 3306, 
</span><span class='line'>            master_user = 'repl', 
</span><span class='line'>            master_password = 'repl', 
</span><span class='line'>            master_log_file = 'mysql-bin.000001', 
</span><span class='line'>            master_log_pos = 796;</span></code></pre></td></tr></table></div></figure>


<ol>
<li>测试一下standby->slave replication.</li>
</ol>


<p>总的思路就是讲master(3),standby(2),slave(1)同步成master(3),standby(2),slave(2),然后将master->slave切换成standby->slave.</p>

<p>遗留了两个问题,其一是slave和standby同步时使用了&#8221;坏掉&#8221;的master;其二是master超前了standby和slave, 也就是standby->slave丢失了master的超前数据。留待慢慢学习。</p>
</div>
  
  


    </article>
  
  
    <article class="b2">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/05/12/mysql-binlog-study/" style='font-size:20px'>关于Mysql Binlog的一点学习</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-12T22:59:00+08:00" pubdate data-updated="true">May 12<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/05/12/mysql-binlog-study/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"关于Mysql binlog的一点学习", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>差不多一个月没更新了。除了忙些琐事，就是偷点懒。</p>

<p>在读&lt;Mysql High Availability&gt;，扫了一遍，读第二遍的时候开始做些实验，所以这之后的blog写的也会没什么章法。</p>

<p>&lt;Mysql High Availability&gt;第三章介绍binlog时特地提到了Rand()/Now()/User variable/Password()在基于sql复制时的行为，简单做些实验。</p>

<ol>
<li>Rand()</li>
</ol>


<p>Rand() 在replication中，值会被正确传递。如下查看binlog，发现pos 209处rand_seed会被传给slave，保证rand生成的值保持一致。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql> show binlog events in 'master-bin.000007';
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| Log_name          | Pos | Event_type  | Server_id | End_log_pos | Info                                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| master-bin.000007 |   4 | Format_desc |         1 |         107 | Server ver: 5.5.31-0ubuntu0.12.04.1-log, Binlog ver: 4 |
</span><span class='line'>| master-bin.000007 | 107 | Query       |         1 |         174 | BEGIN                                                  |
</span><span class='line'>| master-bin.000007 | 174 | RAND        |         1 |         209 | rand_seed1=598597315,rand_seed2=24268577               |
</span><span class='line'>| master-bin.000007 | 209 | Query       |         1 |         302 | use `tac`; insert into test values(rand())             |
</span><span class='line'>| master-bin.000007 | 302 | Xid         |         1 |         329 | COMMIT /* xid=151 */                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Now()</li>
</ol>


<p>Now() 在replication中，值会被正确传递。如下查看binlog，pos 283处，貌似这个语句传给slave，会由于master和slave的时间不同步，导致问题。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master> flush logs;
</span><span class='line'>     master> SET TIMESTAMP=unix_timestamp('2010-10-01 12:00:00');
</span><span class='line'>     master> insert into test values(now());
</span><span class='line'>     master> show binlog events in 'master-bin.000007';
</span><span class='line'>
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| Log_name          | Pos | Event_type  | Server_id | End_log_pos | Info                                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| master-bin.000012 |   4 | Format_desc |         1 |         107 | Server ver: 5.5.31-0ubuntu0.12.04.1-log, Binlog ver: 4 |
</span><span class='line'>| master-bin.000012 | 107 | Query       |         1 |         182 | BEGIN                                                  |
</span><span class='line'>| master-bin.000012 | 182 | Query       |         1 |         283 | use `tac`; insert into test values (now())             |
</span><span class='line'>| master-bin.000012 | 283 | Xid         |         1 |         310 | COMMIT /* xid=131 */                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>但通过mysqladmin查看binlog，可以看到binlog中会不断插入TIMESTAMP来保证now()函数的执行结果在master和slave是相同的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>master> sudo mysqlbinlog --short-form master-bin.000017
</span><span class='line'>... 
</span><span class='line'>DELIMITER /*!*/;
</span><span class='line'>SET TIMESTAMP=1285934400/*!*/;
</span><span class='line'>...
</span><span class='line'>BEGIN
</span><span class='line'>/*!*/;
</span><span class='line'>use `tac`/*!*/;
</span><span class='line'>SET TIMESTAMP=1285934400/*!*/;
</span><span class='line'>insert into test values(now())
</span><span class='line'>/*!*/;
</span><span class='line'>COMMIT/*!*/;
</span><span class='line'>SET TIMESTAMP=1368372377/*!*/;
</span><span class='line'>BEGIN
</span><span class='line'>/*!*/;
</span><span class='line'>SET TIMESTAMP=1368372377/*!*/;
</span><span class='line'>insert into test values(now())
</span><span class='line'>/*!*/;
</span><span class='line'>COMMIT/*!*/;
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<ol>
<li>User variable</li>
</ol>


<p>User variable会被编码成十六进制串，含义不明，保密性不明。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql> flush logs;
</span><span class='line'>Query OK, 0 rows affected (0.02 sec)
</span><span class='line'>
</span><span class='line'>mysql> set @foo = now();
</span><span class='line'>Query OK, 0 rows affected (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql> insert into test values (@foo);
</span><span class='line'>Query OK, 1 row affected (0.01 sec)
</span><span class='line'>
</span><span class='line'>mysql> show binlog events in 'master-bin.000014';
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------------------------------+
</span><span class='line'>| Log_name          | Pos | Event_type  | Server_id | End_log_pos | Info                                                                              |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------------------------------+
</span><span class='line'>| master-bin.000014 |   4 | Format_desc |         1 |         107 | Server ver: 5.5.31-0ubuntu0.12.04.1-log, Binlog ver: 4                            |
</span><span class='line'>| master-bin.000014 | 107 | Query       |         1 |         174 | BEGIN                                                                             |
</span><span class='line'>| master-bin.000014 | 174 | User var    |         1 |         229 | @`foo`=_latin1 0x323031302D31302D30312031323A30303A3030 COLLATE latin1_swedish_ci |
</span><span class='line'>| master-bin.000014 | 229 | Query       |         1 |         321 | use `tac`; insert into test values (@foo)                                         |
</span><span class='line'>| master-bin.000014 | 321 | Xid         |         1 |         348 | COMMIT /* xid=148 */                                                              |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+-----------------------------------------------------------------------------------+
</span><span class='line'>5 rows in set (0.00 sec)</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Password()</li>
</ol>


<p>直接内嵌使用password，会在binlog里暴露密码，就像下面的测试。可以使用user variable,但是不知道user variable的编码保密性如何。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql> insert into test values(password('tac'));
</span><span class='line'>mysql> show binlog events in 'master-bin.000015';
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| Log_name          | Pos | Event_type  | Server_id | End_log_pos | Info                                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>| master-bin.000015 |   4 | Format_desc |         1 |         107 | Server ver: 5.5.31-0ubuntu0.12.04.1-log, Binlog ver: 4 |
</span><span class='line'>| master-bin.000015 | 107 | Query       |         1 |         174 | BEGIN                                                  |
</span><span class='line'>| master-bin.000015 | 174 | Query       |         1 |         276 | use `tac`; insert into test values(password('tac'))    |
</span><span class='line'>| master-bin.000015 | 276 | Xid         |         1 |         303 | COMMIT /* xid=158 */                                   |
</span><span class='line'>+-------------------+-----+-------------+-----------+-------------+--------------------------------------------------------+
</span><span class='line'>4 rows in set (0.01 sec)</span></code></pre></td></tr></table></div></figure>


<p>简单一点学习如上。</p>
</div>
  
  


    </article>
  
  
    <article class="b3">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/04/16/lisp-symbol-upper-case/" style='font-size:20px'>Lisp一个大写的坑</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-16T23:12:00+08:00" pubdate data-updated="true">Apr 16<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/04/16/lisp-symbol-upper-case/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"lisp一个大写的坑", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>最近一直掉在一个坑里，今天刚出坑</p>

<p>想用宏定义不同的函数，类似于:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(defmacro macro (name)
</span><span class='line'>     `(defmethod ,(intern (format nil "set-~a" name)) ()))</span></code></pre></td></tr></table></div></figure>


<p>跑(macro test)，结果就是</p>

<figure class='code'><figcaption><span>函数名是&#8221;|set-TEST|&#8221;，而不是需要的&#8221;set-test&#8221;</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#&lt;STANDARD-METHOD |set-TEST| NIL></span></code></pre></td></tr></table></div></figure>


<p>几天的困惑以后（尝试换过lisp的实现去测试），找到了<a href="http://www.cs.rochester.edu/~schubert/247-447/symbols-in-lisp.html">这篇文章</a>，发现是符号名大小写引起的问题</p>

<figure class='code'><figcaption><span>简单测试一下</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CL-USER> (eq (intern "test") 'test)
</span><span class='line'>NIL
</span><span class='line'>CL-USER> (intern "test")
</span><span class='line'>|test|
</span><span class='line'>:INTERNAL
</span><span class='line'>CL-USER> (eq (intern "TEST") 'test)
</span><span class='line'>T
</span><span class='line'>CL-USER> (intern "TEST")
</span><span class='line'>TEST
</span><span class='line'>:INTERNAL</span></code></pre></td></tr></table></div></figure>


<p>大小写通过intern生成的符号是不一样的，全大写才会生成正确的符号。</p>

<p>参考：</p>

<p><a href="http://www.cs.rochester.edu/~schubert/247-447/symbols-in-lisp.html">How to handle symbols in LISP</a></p>
</div>
  
  


    </article>
  
  
    <article class="b4">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/31/java-method-passing/" style='font-size:20px'>我写了半辈子程序 & Java的重载方法选择基于编译期参数类型</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-31T23:22:00+08:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/31/java-method-passing/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"我写了半辈子程序 & java的重载方法选择基于编译期参数类型", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>一段时间没更新过blog,因为花了些时间在读lisp的入门,还将继续一段时间</p>

<p>先庆祝下自己25岁,可以正式对外宣称&#8221;我写了半辈子程序&#8221;</p>

<p>读lisp的入门时,有一个java的对比例子觉得很有意思(虽然事后想想也就那么回事)&#8230;</p>

<p>简单的说,一个call传递给object(根据运行时的类型找到需要处理这个call的类),并找到对应的方法(根据call参数的编译时类型,找到需要处理这个call的函数),并执行</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;A/A&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(</span><span class="n">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;A/B&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">B</span> <span class="kd">extends</span> <span class="n">A</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(</span><span class="n">A</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;B/A&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">foo</span><span class="o">(</span><span class="n">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;B/B&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">C</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="c1">//        A obj = new A();</span>
</span><span class='line'>        <span class="n">A</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">B</span><span class="o">();</span>
</span><span class='line'>        <span class="n">obj</span><span class="o">.</span><span class="na">foo</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行结果是&#8221;B/A&#8221;,B这个类是根据运行类型找到的,foo(A)这个方法是根据编译类型找到的。</p>
</div>
  
  


    </article>
  
  
    <article class="b5">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/19/some-readings-about-localStorage/" style='font-size:20px'>读了“There Is No Simple Solution for Local Storage”</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T23:35:00+08:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/19/some-readings-about-localStorage/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"读了“There is no simple solution for local storage”", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>作为一个非专职Client开发,偶然读了读关于localStorage的<a href="http://www.36ria.com/6075">这篇有趣的文字</a>,非常有意思,引文也很值得一读。</p>

<p>作者的思考方向很全面。摘取其中重要的部分：</p>

<ol>
<li><p>(性能) localStorage是会阻止渲染(同步),会写I/O</p></li>
<li><p>(浏览器行为) localStorage会被浏览器预载入,会被永久存储,浏览器支持良好</p></li>
<li><p>(开发接口) 接口简单。缺少getSize这样的接口</p></li>
<li><p>(用户接口) 用户授权简单</p></li>
</ol>


<p>解决localStorage问题的方案,可能是升级或者寻找替代品,衡量的方向也是上面几点。</p>

<p>值得一读的引文：</p>

<p><a href="http://htmlui.com/blog/2011-08-23-5-obscure-facts-about-html5-localstorage.html">这篇引文</a> 描述了LocalStorage的几个限制。值得注意的是http和https的localStorage不能互通。</p>

<p><a href="https://hacks.mozilla.org/2012/02/saving-images-and-files-in-localstorage/">Saving images and files in localStorage</a></p>
</div>
  
  


    </article>
  
  
    <article class="b6">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/18/lisp-quote-backquote/" style='font-size:20px'>略学习Lisp的quote和backquote</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-18T23:59:00+08:00" pubdate data-updated="true">Mar 18<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/18/lisp-quote-backquote/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"略学习Lisp的quote和backquote", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>略学习了lisp里面奇怪的符号集，解释这些符号上，人类的语言基本是苍白的。</p>

<p><a href="http://www.lispworks.com/documentation/HyperSpec/Body/02_df.htm">第一份参考</a>来自lispworks的文档，对[`&#8217;@,]这几种符号做了定义。</p>

<p><a href="http://wenku.it168.com/d_000648782.shtml">第二份中文参考</a> 被到处抄袭。对quote和backquote做了很好的中文说明，嵌套quote部分惨不忍睹。</p>

<p><a href="http://stackoverflow.com/questions/7549550/using-two-backquotes-and-commas-common-lisp">第三份参考</a> 对嵌套quote做了很好地解释。</p>

<figure class='code'><figcaption><span>贴一些自己的学习代码 </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CL-USER> (list 1 2)
</span><span class='line'>(1 2)
</span><span class='line'>CL-USER> '(1 2)
</span><span class='line'>(1 2) ;Quote act as list
</span><span class='line'>CL-USER> `(1 2)
</span><span class='line'>(1 2) ;Backquote act as list
</span><span class='line'>
</span><span class='line'>CL-USER> (let ((x 1)) '(,x))
</span><span class='line'>; Evaluation aborted on #&lt;CCL::SIMPLE-READER-ERROR #xC78878E>. ;Quote can't work with comma
</span><span class='line'>CL-USER> (let ((x 1)) `(,x))
</span><span class='line'>(1) ;Backquote can work with comma
</span><span class='line'>
</span><span class='line'>CL-USER> (let ((x `(1 2))) `(,@x))
</span><span class='line'>(1 2) ;BackQuote can work with comma-at-sign
</span><span class='line'>
</span><span class='line'>CL-USER> (let ((x `(1 2))) `(,x))
</span><span class='line'>((1 2)) ;x will not be "expand" when use comma instead of comma-at-sign</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article class="b7">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/17/jquery-noconflict/" style='font-size:20px'>读了‘谈谈 jQuery 中的防冲突（noConflict）机制’</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-17T23:49:00+08:00" pubdate data-updated="true">Mar 17<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/17/jquery-noconflict/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"读了‘谈谈 jQuery 中的防冲突（noConflict）机制’", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>文章在此：<a href="http://ued.taobao.com/blog/2013/03/jquery-noconflict/">http://ued.taobao.com/blog/2013/03/jquery-noconflict/</a></p>

<p>倒是也没什么大不了的，略感叹jquery的api设计的周到。</p>
</div>
  
  


    </article>
  
  
    <article class="b1">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/14/read-write-lock-read-reentrant/" style='font-size:20px'>读写锁-读可重入</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-14T21:37:00+08:00" pubdate data-updated="true">Mar 14<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/14/read-write-lock-read-reentrant/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"读写锁-读可重入", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>发现<a href="http://tutorials.jenkov.com/java-concurrency/read-write-locks.html">这篇文献</a>描写读写锁和可重入性非常具体。</p>

<p>尝试实现文章中的读可重入的读写锁：</p>

<p>考虑如何测试一个读可重入的读写锁, 由于读写锁的性质(可以同时存在多个读锁), 如果只是在线程A连续申请两个读锁, 就无法证明是锁的重入性发挥了作用。</p>

<p>测试思路是先在线程A申请读锁, 然后在线程B申请写锁, 若在线程C申请读锁, 此读锁应阻塞。而如果在线程A申请另一个读锁(前一个未释放), 线程A不应被阻塞。</p>

<figure class='code'><figcaption><span>测试代码(我的确用了Main来测试&#8230;)  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">final</span> <span class="n">ReadWriteLockReadReentrant</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReadWriteLockReadReentrant</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">new</span> <span class="nf">Thread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">lockRead</span><span class="o">();</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Reading&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Inner Reading&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">lockRead</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Inner Reading End&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">unlockRead</span><span class="o">();</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Reading End&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">unlockRead</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>  <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">new</span> <span class="nf">Thread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="nd">@Override</span>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Request write lock&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">lockWrite</span><span class="o">();</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Writing&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Writing End&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">lock</span><span class="o">.</span><span class="na">unlockWrite</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果应当是：Reading(线程A),Request write lock(线程B),Inner Reading(未阻塞),Inner Reading End,Reading End,Writing,Writing End</p>

<figure class='code'><figcaption><span>读重入的读写锁(基本是抄上面文献的代码~)  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteLockReadReentrant</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">hasWriter</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">writeRequests</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">readers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">lockRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(!</span><span class="n">couldRead</span><span class="o">(</span><span class="n">current</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">wait</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">readers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">getReaders</span><span class="o">(</span><span class="n">current</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">getReaders</span><span class="o">(</span><span class="n">Thread</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">readers</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">current</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">readers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">couldRead</span><span class="o">(</span><span class="n">Thread</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">hasWriter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">readers</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">current</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//important</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">writeRequests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">unlockRead</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span><span class='line'>        <span class="n">setReaders</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">getReaders</span><span class="o">(</span><span class="n">current</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">notifyAll</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setReaders</span><span class="o">(</span><span class="n">Thread</span> <span class="n">current</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">now</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">readers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">readers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">now</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">lockWrite</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">writeRequests</span><span class="o">++;</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="n">readers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">wait</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">writeRequests</span><span class="o">--;</span>
</span><span class='line'>        <span class="n">hasWriter</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">unlockWrite</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">hasWriter</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="n">notifyAll</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是标记&#8221;//important&#8221;的那行，如果这个判断和writeRequest的判断互换位置，线程B申请写锁被阻塞时，线程A无法申请到第二个读锁。一切就悲剧了。</p>

<figure class='code'><figcaption><span>标记为&#8221;//important&#8221;的判断和writeRequest的判断互换位置  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">couldRead</span><span class="o">(</span><span class="n">Thread</span> <span class="n">current</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">hasWriter</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">writeRequests</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">readers</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">current</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//important</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article class="b2">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/13/reentrant-lock/" style='font-size:20px'>可重入Lock</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-13T23:01:00+08:00" pubdate data-updated="true">Mar 13<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/13/reentrant-lock/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"可重入Lock", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>参考：<a href="http://book.douban.com/subject/10484692/">Java并发编程实践</a></p>

<p>参考书里2.3.2对锁的重入性一句话搞定：“获取所得粒度是&#8221;线程&#8221;，而不是&#8221;调用&#8221;”</p>

<p>下面的代码验证内置锁(synchronize)和Lock(ReentrantLock)的重入性</p>

<figure class='code'><figcaption><span>内置锁可重入  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reentrant</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Reentrant</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method1 run&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">method2</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Reentrant</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method2 run in method1&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">Reentrant</span><span class="o">().</span><span class="na">method1</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Lock对象可重入  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reentrant2</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method1 run&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">method2</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;method2 run in method1&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">Reentrant2</span><span class="o">().</span><span class="na">method1</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在同一线程里，method1调用持同样锁的method2，不会等锁。这就是锁的&#8221;重入&#8221;。</p>

<figure class='code'><figcaption><span>不同线程里锁不可重入  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Reentrant3</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Thread 1 start&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Thread 1 end&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T2</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Thread 2 start&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class='line'>            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Thread 2 end&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">T1</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>      <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">T2</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>不同线程可以看到T2一定会等到T1释放锁之后。</p>
</div>
  
  


    </article>
  
  
    <article class="b3">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/13/notify-and-notify-all/" style='font-size:20px'>Thread Notify 和 NotifyAll</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-13T21:47:00+08:00" pubdate data-updated="true">Mar 13<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/13/notify-and-notify-all/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"Thread Notify 和 NotifyAll", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>参考：<a href="http://blog.csdn.net/iceman1952/article/details/2159812">http://blog.csdn.net/iceman1952/article/details/2159812</a></p>

<figure class='code'><figcaption><span>notify  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Notify</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">T</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">super</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%s run.&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Notify</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Notify</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;%s done.&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">T</span><span class="o">(</span><span class="s">&quot;thread 1&quot;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">T</span><span class="o">(</span><span class="s">&quot;thread 2&quot;</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;notify&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">Notify</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Notify</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span><span class='line'>            <span class="c1">//Notify.class.notifyAll(); //alternative</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notify版本主线程是不会退出的，因为释放了一个wait，另一个就会等到天荒地老。</p>

<p>NotifyAll主线程会退出。</p>
</div>
  
  


    </article>
  
  
    <article class="b4">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/11/thread-wait-sleep/" style='font-size:20px'>Thread Wait 和 Sleep</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-11T22:32:00+08:00" pubdate data-updated="true">Mar 11<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/11/thread-wait-sleep/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"Thread wait 和 sleep", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>ifeve上发现几个多线程的<a href="http://ifeve.com/javaconcurrency-interview-questions-base/">基础问题</a>。我一直不写多线程（我这两年到底都写了些什么~），重头学起。</p>

<p>sleep和wait的区别。sleep让出cpu，等一段时间，重新进入竞争，不释放锁。wait等一个状态notify，才重新进入竞争，但释放锁。</p>

<p>下面代码说明是否释放锁的区别：</p>

<figure class='code'><figcaption><span>sleep不会释放锁  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThread</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">MultiThread</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 run&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 sleep&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 wake up&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T2</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">MultiThread</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T2 run&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">T1</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">T2</span><span class="o">());</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">//dispose</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>wait会释放锁  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThread2</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">MultiThread2</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 run&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 wait&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">MultiThread2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T1 wake up&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T2</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">MultiThread2</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;T2 run&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">T1</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">T2</span><span class="o">());</span>
</span><span class='line'>      
</span><span class='line'>      <span class="c1">//dispose</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">MultiThread2</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">MultiThread2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">executorService</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>sleep的执行结果是T1 run, T1 sleep, T1 wake up, T2 run</p>

<p>wait的执行结果是T1 run, T1 wait, T2 run (此处锁被释放, T2获得锁), T1 wake up</p>
</div>
  
  


    </article>
  
  
    <article class="b5">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/10/false-sharing-0/" style='font-size:20px'>False Sharing 阅读</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-10T23:40:00+08:00" pubdate data-updated="true">Mar 10<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/10/false-sharing-0/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"False Sharing 阅读", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>应该说<a href="http://ifeve.com/disruptor-cacheline-padding/">这篇</a>和<a href="http://ifeve.com/false-sharing/">这篇文章</a>是最近读的最有意思的一篇文章，关于多线程访问时，内存预读到寄存器的内容产生的数据竞争(false sharing)对性能的影响(我已经不知道我在说什么了，文章里解释的很清楚)。</p>

<p>重做了第二篇里的试验，发现六个padding不够，需要七个padding(p7)才能有两倍的性能差异。(没有文献里说的那么离谱，测试环境的差异吧)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">long</span> <span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="n">p3</span><span class="o">,</span> <span class="n">p4</span><span class="o">,</span> <span class="n">p5</span><span class="o">,</span> <span class="n">p6</span><span class="o">;</span> <span class="c1">// comment out</span>
</span></code></pre></td></tr></table></div></figure>


<p><del>TODO：了解第七个padding的来源</del></p>

<p>看了第二篇文章的<a href="http://ifeve.com/false-shareing-java-7-cn/">更新篇</a>, 用这个稳定的代码跑测试，就不会有之前p7的问题。（可能是之前p1-p6被优化掉了？不解。）</p>

<p>在公司八核的机器上也测过，性能提升也就在2-4倍左右。没有那么夸张。</p>

<p>原理基本清楚，对不同平台间的差异完全没想法。不做深入了解。</p>
</div>
  
  


    </article>
  
  
    <article class="b6">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/03/05/chrome-workspace/" style='font-size:20px'>Chrome Workspace和File Mapping的使用方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-05T22:21:00+08:00" pubdate data-updated="true">Mar 5<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/03/05/chrome-workspace/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"Chrome Workspace和File Mapping的使用方法", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>前几天微博上一直在转Chrome browser引进了workspace的功能，可以在developer tools里直接进行源码编辑。</p>

<p>但是迄今为止搜索到的文档都没有详细描述使用步骤和限制，36kr上的<a href="http://www.36kr.com/p/201304.html">这篇guide</a>也没有关于mapping的描述，更没有一些坑描述。</p>

<p>翻看了Chromium的源代码，将使用步骤和在Windows下的坑描述一下。(截止20130305，这个步骤还是很新的)。</p>

<h2>浏览器版本</h2>

<p>如果是Chrome(谷歌浏览器)，只有开发者分支上有这个功能，地址<a href="https://www.google.com/intl/en/chrome/browser/index.html?extra=devchannel#eula">在此</a></p>

<p>如果是Canary或者Chromium，都有这个功能。</p>

<h2>使用步骤</h2>

<ol>
<li><p>开启&#8221;开发者工具实验&#8221;(这翻译真心烂&#8230;): 在browser输入chrome://flags/，启用&#8221;开发者工具实验&#8221;
<img src="/blog/images/2013-03-05-chrome-workspace-1.png" title="启用&#34;开发者工具实验&#34;" alt="启用&#34;开发者工具实验&#34;"></p></li>
<li><p>重启chrome</p></li>
<li><p>打开要调试的site，进入Developer tools的setting
<img src="/blog/images/2013-03-05-chrome-workspace-2.png" title="进入Developer tools的setting" ></p></li>
<li><p>启用Workspace功能 (Developer tools -> setting -> Experiments -> File system folders in Sources Panel)
<img src="/blog/images/2013-03-05-chrome-workspace-3.png" title="启用Workspace功能" ></p></li>
<li><p>重启Developer Tools, 可以看到Settings里Workspace页
<img src="/blog/images/2013-03-05-chrome-workspace-4.png" title="Settings里Workspace页" ></p></li>
<li><p>假设源js的目录为c:\test, 需要现在这个目录下创建空文件.allow-devtools-edit, browser才会认可这个为源文件夹
<img src="/blog/images/2013-03-05-chrome-workspace-5.png" title="创建空文件.allow-devtools-edit" ></p></li>
<li><p>在Developer tool -> setting ->Workspace -> File system里，添加源js的目录
<img src="/blog/images/2013-03-05-chrome-workspace-6.png" title="创建空文件.allow-devtools-edit" ></p></li>
<li><p>重启Developer Tools, 可以在Sources页里看到本地folder
<img src="/blog/images/2013-03-05-chrome-workspace-7.png" title="可以在Sources页里看到本地folder" ></p></li>
<li><p>此时在Chrome用Ctrl + O打开文件列表，可以看到两个相同的文件，一个是远端，一个是本地。在本地文件上打断点没有作用
<img src="/blog/images/2013-03-05-chrome-workspace-8.png" title="Ctrl + O打开文件列表，可以看到两个相同的文件" ></p></li>
<li><p>在Developer tool -> setting ->Workspace -> Mappings里，添加mapping：
<code>
http://localhost:7001/.../js/slickgrid C:\test
</code></p></li>
</ol>


<p><em>URL是以http开头的完整路径，url和path都万万不要以/结尾，虽然添加后会自动显示为以/结尾。千万注意大小写会坑爹，要保持mapping和folder的大小写一致</em>
<img src="/blog/images/2013-03-05-chrome-workspace-9.png" title="添加mapping" ></p>

<ol>
<li>此时，用Ctrl + O打开文件列表，只能看到一个文件，在本地文件上可以打断点(此处有坑，请阅读坑部分)，对本地文件的修改也会灵验的(直接反应在C:\test中)。</li>
</ol>


<h2>坑</h2>

<ol>
<li>千万别在mapping的路径后加&#8217;/&#8217;（保存时会自动加上去），否则可能mapping不上。</li>
<li>大小写会坑爹，千万保持mapping和folder的大小写一致。</li>
<li>如果你的远端文件路径带参数，比如http://xxx/js/1.js?d=1，断点不会触发。已经<a href="https://code.google.com/p/chromium/issues/detail?id=180202">报了个bug</a></li>
</ol>


<p>应该说workspace是挺有用的功能，不过由于坑3，在项目中的运用不畅。本想自己修修，发现这个bug涉及c++代码，表示放弃。</p>
</div>
  
  


    </article>
  
  
    <article class="b7">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/28/lisp-book/" style='font-size:20px'>在读lisp入门</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-28T00:20:00+08:00" pubdate data-updated="true">Feb 28<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/28/lisp-book/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"在读lisp入门", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>花了几天时间在读<a href="http://book.douban.com/subject/11238123">lisp的入门</a>。</p>

<p>是本写得十分中肯的语言书。冗长，事无巨细，配图和代码样例精准。就算不看冗长的英文只看代码样例，也能了解个大概。对lisp辅助工具的介绍非常详尽，就算是programming ruby也没达到这个程度。习题丰富。</p>
</div>
  
  


    </article>
  
  
    <article class="b1">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/21/git-study/" style='font-size:20px'>Git入门</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-21T21:10:00+08:00" pubdate data-updated="true">Feb 21<span>st</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/21/git-study/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"Git入门", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>花了两天完成<a href="http://pcottle.github.com/learnGitBranching">这个教程</a>。作为git的入门非常好。</p>
</div>
  
  


    </article>
  
  
    <article class="b2">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/19/ifttt/" style='font-size:20px'>测试一下ifttt根据blog Rss更新linkedin和evernote</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-19T23:16:00+08:00" pubdate data-updated="true">Feb 19<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/19/ifttt/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"测试一下ifttt根据blog rss更新linkedin和evernote", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>测试一下ifttt根据blog rss更新linkedin和evernote</p>
</div>
  
  


    </article>
  
  
    <article class="b3">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/14/css-clear/" style='font-size:20px'>Css Clear属性</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-14T23:00:00+08:00" pubdate data-updated="true">Feb 14<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/14/css-clear/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"css clear属性", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>开始学习css。
<a href="http://www.amazon.com/CSS-Cookbook-Edition-Animal-Guide/dp/059615593X/">css cookbook</a> 2.21讨论了clear的用法。</p>

<p>简单做了个实验。</p>

<figure class='code'><figcaption><span>http://jsfiddle.net/PzwkP  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">img</span> <span class="kr">class</span><span class="o">=</span><span class="s1">&#39;leftFloat&#39;</span> <span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">test</span> <span class="nx">test</span> <span class="nx">line</span> <span class="mi">1</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">img</span> <span class="nx">style</span><span class="o">=</span><span class="s1">&#39;clear:left&#39;</span> <span class="kr">class</span><span class="o">=</span><span class="s1">&#39;rightFloat&#39;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span> <span class="nx">style</span><span class="o">=</span><span class="s1">&#39;clear:left&#39;</span><span class="o">&gt;</span><span class="nx">test</span> <span class="nx">test</span> <span class="nx">line</span> <span class="mi">2</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">test</span> <span class="nx">test</span> <span class="nx">line</span> <span class="mi">3</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>总的感觉就是clear可以某方向(left/right/both)上的浮动元素算成固定元素，来决定当前元素的高度。</p>

<p>书中只是简单地一句话，实践起来float和固定元素需要分别clear。(可以将两个clear:left随便去掉一个，相应的元素就会上浮)。</p>

<p><css cookbook> 2.22也讨论了利用clear来撑开float元素所在容器的方法。参考里面也描述了同样的用法。</p>

<p>一些参考：</p>

<p><a href="http://www.w3school.com.cn/css/css_positioning_floating.asp">http://www.w3school.com.cn/css/css_positioning_floating.asp</a> 介绍了floating和clear，涵盖了<css cookbook>2.21 &amp; 2.22的内容</p>
</div>
  
  


    </article>
  
  
    <article class="b4">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/04/Q-uncurry-safe-meta-programming/" style='font-size:20px'>Q源码里uncurry函数分析</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T23:04:00+08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/04/Q-uncurry-safe-meta-programming/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"Q源码里uncurry函数分析", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p><a href="http://documentup.com/kriskowal/q/">Q</a>里关于uncurry的代码</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Attempt to make generics safe in the face of downstream</span>
</span><span class='line'><span class="c1">// modifications.</span>
</span><span class='line'><span class="c1">// There is no situation where this is necessary.</span>
</span><span class='line'><span class="c1">// If you need a security guarantee, these primordials need to be</span>
</span><span class='line'><span class="c1">// deeply frozen anyway, and if you don’t need a security guarantee,</span>
</span><span class='line'><span class="c1">// this is just plain paranoid.</span>
</span><span class='line'><span class="c1">// However, this does have the nice side-effect of reducing the size</span>
</span><span class='line'><span class="c1">// of the code by reducing x.call() to merely x(), eliminating many</span>
</span><span class='line'><span class="c1">// hard-to-minify characters.</span>
</span><span class='line'><span class="c1">// See Mark Miller’s explanation of what this does.</span>
</span><span class='line'><span class="c1">// http://wiki.ecmascript.org/doku.php?id=conventions:safe_meta_programming</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">uncurryThis</span><span class="p">;</span>
</span><span class='line'><span class="c1">// I have kept both variations because the first is theoretically</span>
</span><span class='line'><span class="c1">// faster, if bind is available.</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">Function_bind</span> <span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">uncurryThis</span> <span class="o">=</span> <span class="nx">Function_bind</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">Function_bind</span><span class="p">.</span><span class="nx">call</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">uncurryThis</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">array_slice</span> <span class="o">=</span> <span class="nx">uncurryThis</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Uncurry/反柯西化的定义可参见<a href="http://en.wikipedia.org/wiki/Uncurry">wiki</a>，不是吾等凡人可以理解的。</p>

<p>从结果看，假设想调用[].slice，如果用uncurryThis(Array.prototype.slice)([])这种形式，可以防止其后[].slice被重写或者[].slice.call被重写。保证当前代码被保护起来，不受之后代码函数重写的影响。</p>

<p>对于Q里用到的这种形式，前提条件是Function.prototype.bind和Function.prototype.bind.call在之前不被重写。简单推导array_slice</p>

<figure class='code'><figcaption><span>array_slice推导  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">array_slice</span> <span class="o">=</span> <span class="nx">uncurryThis</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">)</span>
</span><span class='line'><span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">call</span><span class="p">)(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">)</span>
</span><span class='line'><span class="o">=</span> <span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">bind</span><span class="p">.</span><span class="nx">call</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">)</span> <span class="c1">//Function.prototype.bind.call.bind is safe</span>
</span><span class='line'><span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span> <span class="c1">//Array.prototype.slice.call is safe</span>
</span><span class='line'><span class="c1">//Array.prototype.slice is also safe</span>
</span></code></pre></td></tr></table></div></figure>


<p>不过，Q的注释里写的很清楚，uncurry在这里不是必要的&#8230; 写写而已&#8230;</p>

<p>一些参考：</p>

<p><a href="http://wiki.ecmascript.org/doku.php?id=conventions:safe_meta_programming">这篇文章</a> 详细介绍了safe meta programming，对uncurry做了定义和代码演示。</p>
</div>
  
  


    </article>
  
  
    <article class="b5">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/04/octopress-chinese-character/" style='font-size:20px'>Octopress Win7上遭遇invalid GBK Character Exception</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T21:59:00+08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/04/octopress-chinese-character/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"octopress win7上遭遇invalid GBK character exception", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>解决方案：
将markdown文件保存格式设为 UTF-8 without BOM，并
在环境变量里加上 LC_ALL=zh_CN.UTF-8</p>
</div>
  
  


    </article>
  
  
    <article class="b6">
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/blog/2013/02/04/css-compressor-bug/" style='font-size:20px'>CSS Compressor Bug</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-04T21:49:00+08:00" pubdate data-updated="true">Feb 4<span>th</span>, 2013</time>
        
		<script type="text/javascript" charset="utf-8">
		(function(){
		  var _w = 72 , _h = 16;
		  var param = {
			url:location.href.substring(0, location.href.length) + "/blog/2013/02/04/css-compressor-bug/",
			type:'3',
			count:'1', 
			appkey:'', 
			title:"CSS compressor bug", 
			pic:'', 
			ralateUid:'1460219211', 
			language:'zh_cn', 
			rnd:new Date().valueOf()
		  }
		  var temp = [];
		  for( var p in param ){
			temp.push(p + '=' + encodeURIComponent( param[p] || '' ) )
		  }
		  document.write('<iframe allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="'+ _w+'" height="'+_h+'" style="margin-left:10px;"></iframe>')
		})()
		</script>
      </p>
	  
    
  </header>


  <div class="entry-content"><p>使用<a href="http://www.csscompressor.com/">css compressor</a> 压缩项目中的css，可以合并相同定义的style，但也引起了bug。</p>

<p>比如：</p>

<figure class='code'><figcaption><span>.A的类型应当是background: BB  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.A</span><span class="o">,</span> <span class="nc">.B</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="n">BB</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.A</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="n">AA</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">//</span><span class="nt">in</span> <span class="nt">another</span> <span class="nt">file</span>
</span><span class='line'><span class="nc">.A</span><span class="o">,</span> <span class="nc">.B</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="n">BB</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>压缩后，.A的类型变为background: AA  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.A</span><span class="o">,</span> <span class="nc">.B</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="n">BB</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.A</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">background</span><span class="o">:</span> <span class="n">AA</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为合并了相同定义，覆盖关系被打乱。</p>

<p>暂时没找到好的css compressor，来分解并合并css</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/blog/2014/02/11/try-rollback-master-back-to-slave-by-mysql-plugin/">尝试使用mysql plugin将RESET SLAVE后的节点重新恢复成slave</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/01/28/compile-mysql-plugin/">编译mysql插件的碰到的问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2014/01/08/jruby-bug-tcp-timeout/">jruby中tcp阻塞时Timeout::timeout失效</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/12/26/go-iterate-variable/">栽在Go中for的变量</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/12/19/paxos-lease-2/">对于PaxosLease的个人理解 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/12/19/paxos-lease/">对于PaxosLease的个人理解 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/12/09/test-framework-exp/">关于DEV测试的一些经验总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/11/11/study-memory-reorder-cont/">对Memory Reordering Caught in the Act的学习 续 - 关于go的部分</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/11/07/study-memory-reorder/">对Memory Reordering Caught in the Act的学习</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/11/05/accrual-failure-detector/">对heartbeat φ累积失败检测算法的学习</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/25/study-mysql-bug-70307/">对Mysql bug #70307 的学习</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/22/mysql-flush-logs-make-two-relay-log-file/">Mysql 5.6.12 master上flush logs在slave上产生两个relay-log</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/20/mysql-handle_slave_io-src/">Mysql rpl_slave.cc:handle_slave_io 源码的一些个人分析</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/16/mysql-mysql_binlog_send-src/">Mysql rpl_master.cc:mysql_binlog_send 源码的一些个人分析和吐槽</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/14/mha-failover/">MHA failover时做了些啥</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/11/jruby-175-jre-6-stdin-bug/">jruby backtick + jre 6 会卡住</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/10/11/hole-in-mysql-56-replication-dead-lock/">mysql 5.6.15 replication中碰到的死锁</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/08/29/rewrite-project-into-ruby/">jruby重写java项目的一些总结</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/05/28/interesting-js/">有意思的javascript笔误</a>
      </li>
    
      <li class="post">
        <a href="/blog/blog/2013/05/18/java-offheap-memory/">Java off-heap的一些参考</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Weibo</h1>
  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=10&isTitle=1&noborder=0&isWeibo=1&isFans=0&uid=1460219211&verifier=4d7daebc&dpc=1"></iframe>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ikarishinjieva">@ikarishinjieva</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ikarishinjieva',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Tac Huang (ikari_shinji@github) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tacsay';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa62a96d9f5c956ea3ddb6cca8ad83aa3' type='text/javascript'%3E%3C/script%3E"));
</script>










</body>
</html>
